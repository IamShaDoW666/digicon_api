(()=>{var e={};e.id=38,e.ids=[38],e.modules={2239:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>b,routeModule:()=>x,serverHooks:()=>B,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>q});var a={};t.r(a),t.d(a,{GET:()=>g,POST:()=>w,PUT:()=>y});var i=t(94841),s=t(74854),n=t(74429),o=t(74585),c=t(37321),u=t(33873),l=t.n(u),d=t(29021),p=t.n(d),f=t(9288),h=t.n(f),m=t(11536);let g=(0,m.r)(async(e,r)=>{try{let e=await c.z.batch.findMany({include:{media:!0,createdBy:!0},where:{userId:r.id},orderBy:{createdAt:"desc"}});if(!e)return(0,o.n)("No batches found",404);let t=e.map(e=>({...e,media:e.media.map(e=>({...e,url:`${process.env.BASE_URL}${e.url}`}))}));return(0,o.Y)(t,"Batches found",200)}catch(e){return console.error(e),(0,o.n)("Internal server error",500)}}),w=(0,m.r)(async(e,r)=>{let t=await e.formData(),a=t.getAll("images"),i=l().join(process.cwd(),"public","uploads"),s=[];if(await p().promises.mkdir(i,{recursive:!0}),!a.length)return(0,o.n)("No images found",400);for(let e of a)try{let r=await e.arrayBuffer(),t=Buffer.from(r),a=await h()(t).resize({width:1024}).jpeg({quality:70}).toBuffer(),n=`${Date.now()}-${e.name}`.replace(/\s+/g,""),o=l().join(i,n);await p().promises.writeFile(o,a),s.push({file:e.name,filepath:`/uploads/${n}`})}catch(e){console.error("Error processing image:",e)}let n=(0,c.k)(t.get("reference"));try{let e=await c.z.batch.create({data:{name:`BULK_${Date.now()}${n}`,reference:n,media:{createMany:{data:s.map(e=>({title:e.file,type:"UPLOAD",url:e.filepath,reference:`REF${Date.now()}${e.file}`,uploadedUserId:r.id}))}},createdBy:{connect:{id:r.id}}},include:{media:!0}});return(0,o.Y)(e,"Batch created",200)}catch(e){return s.forEach(async e=>{let r=l().join(i,e.filepath);try{await p().promises.unlink(r)}catch(e){console.error("Error deleting file:",e)}}),console.error("Error creating batch:",e),(0,o.n)("Internal server error",500)}}),y=(0,m.r)(async(e,r)=>{let t=await e.formData(),a=t.getAll("images"),i=l().join(process.cwd(),"public","uploads"),s=[],n=t.get("batchId");if(!a.length&&!t.get("reference"))return(0,o.n)("Nothing to update",400);if(!n)return(0,o.n)("Batch ID is required",400);let u=await c.z.batch.findUnique({where:{id:n}});if(!u)return(0,o.n)("Batch not found",404);for(let e of a)try{let r=await e.arrayBuffer(),t=Buffer.from(r),a=await h()(t).resize({width:1024}).jpeg({quality:80}).toBuffer(),n=`${Date.now()}-${e.name}`.replace(/\s+/g,""),o=l().join(i,n);await p().promises.writeFile(o,a),s.push({file:e.name,filepath:`/uploads/${n}`})}catch(e){console.error("Error processing image:",e)}let d=u.reference;d.slice(7)!==t.get("reference")&&(d=(0,c.k)(t.get("reference")));try{let e=await c.z.batch.update({where:{id:n},include:{media:!0},data:{name:`BULK_${Date.now()}${d}`,reference:d,media:{createMany:{data:s.map(e=>({title:e.file,type:"UPLOAD",url:e.filepath,reference:`REF${Date.now()}${e.file}`,uploadedUserId:r.id}))}},createdBy:{connect:{id:r.id}}}});return(0,o.Y)(e.media,"Batch updated",200)}catch(e){return s.forEach(async e=>{let r=l().join(i,e.filepath);try{await p().promises.unlink(r)}catch(e){console.error("Error deleting file:",e)}}),console.error("Error creating batch:",e),(0,o.n)("Internal server error",500)}}),x=new i.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/batch/route",pathname:"/api/batch",filename:"route",bundlePath:"app/api/batch/route"},resolvedPagePath:"C:\\xampp\\htdocs\\digicon_api\\src\\app\\api\\batch\\route.ts",nextConfigOutput:"standalone",userland:a}),{workAsyncStorage:v,workUnitAsyncStorage:q,serverHooks:B}=x;function b(){return(0,n.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:q})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9288:e=>{"use strict";e.exports=require("sharp")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11536:(e,r,t)=>{"use strict";t.d(r,{r:()=>c});var a=t(68632),i=t(68421),s=t.n(i),n=t(74585);let o=process.env.JWT_SECRET;function c(e){return async r=>{let t,i=r.headers.get("authorization");if(!i?.startsWith("Bearer "))return a.NextResponse.json({error:"Missing or invalid Authorization header"},{status:401});let c=i.slice(7);try{t=s().verify(c,o)}catch(e){return console.log(e),(0,n.n)("Unauthenticated",401)}return e(r,t)}}},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},37321:(e,r,t)=>{"use strict";t.d(r,{k:()=>i,z:()=>s});var a=t(96330);let i=e=>"REF"+Math.floor(1e3+9e3*Math.random()).toString()+e,s=globalThis.prisma??new a.PrismaClient({log:["query"]})},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73329:()=>{},74001:()=>{},74585:(e,r,t)=>{"use strict";t.d(r,{Y:()=>i,n:()=>s});var a=t(68632);function i(e,r="Success",t=200){return a.NextResponse.json({status:!0,statusCode:t,data:e,message:r},{status:t})}function s(e="Something went wrong",r=500,t){return a.NextResponse.json({status:!1,statusCode:r,message:e,error:t},{status:r})}},79428:e=>{"use strict";e.exports=require("buffer")},96330:e=>{"use strict";e.exports=require("@prisma/client")}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[659,550,421],()=>t(2239));module.exports=a})();